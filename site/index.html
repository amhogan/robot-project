<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>RPi-Robot Dashboard</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 1.5rem; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; align-items: start; }
    .card { border: 1px solid #e5e7eb; border-radius: 10px; padding: 1rem; background:#fff; }
    img { max-width: 100%; border-radius: 10px; border: 1px solid #ddd; }
    pre { background: #f6f8fa; padding: .75rem; border-radius: 8px; overflow: auto; }
    .muted{ color:#6b7280; }
    .ok{ color:#059669; } .bad{ color:#dc2626; }
  </style>
</head>
<body>
  <h1>RPi-Robot Dashboard</h1>
  <div class="muted">DASH v11 — Live Video & Telemetry</div>

  <div class="grid">
    <div class="card">
      <h2>Live Video</h2>
      <div id="streamStatus" class="muted">initializing…</div>
      <img id="live" alt="Live Video Stream" src="">
    </div>

    <div class="card">
      <h2>Telemetry</h2>
      <div class="kvs">
        <div><strong>CPU Temp:</strong> <span id="cpu_temp">--</span> °C</div>
        <div><strong>Uptime:</strong> <span id="uptime">--</span></div>
      </div>
      <h3>Status JSON</h3>
      <pre id="status_json">loading…</pre>
    </div>
  </div>

<script>
const topics = ["/image_raw", "/camera/image_raw"];
const live = document.getElementById('live');
const statusEl = document.getElementById('streamStatus');

function withBust(url){ const s = url.includes('?') ? '&' : '?'; return url + s + 't=' + Date.now(); }

async function probe(url, timeoutMs=3000){
  const ctrl = new AbortController();
  const to = setTimeout(()=>ctrl.abort(), timeoutMs);
  try {
    const r = await fetch(url, { signal: ctrl.signal });
    clearTimeout(to);
    // For /stream we won’t finish; we just need headers. Consider any 200 a pass.
    return r.ok;
  } catch { clearTimeout(to); return false; }
}

async function chooseStream(){
  for (const t of topics){
    const url = `/stream?topic=${encodeURIComponent(t)}`;
    const ok = await probe(url, 2000);
    if (ok) return url;
  }
  return null;
}

async function chooseSnapshot(){
  for (const t of topics){
    const url = `/snapshot?topic=${encodeURIComponent(t)}`;
    const ok = await probe(url, 2000);
    if (ok) return url;
  }
  return null;
}

async function startVideo(){
  statusEl.textContent = 'connecting…';
  let url = await chooseStream();
  if (url){
    statusEl.innerHTML = '<span class="ok">stream connected</span>';
    live.src = withBust(url);
    // refresh the <img> every 30s to avoid stale connections
    setInterval(()=> { live.src = withBust(url); }, 30000);
    return;
  }
  // Fallback to snapshots
  let snap = await chooseSnapshot();
  if (snap){
    statusEl.innerHTML = '<span class="bad">stream unavailable, showing snapshots</span>';
    const tick = async ()=>{
      live.src = withBust(snap);
    };
    tick();
    setInterval(tick, 1000);
    return;
  }
  statusEl.innerHTML = '<span class="bad">no video topics reachable</span>';
}

async function updateTelemetry(){
  try {
    const [status, temp, up] = await Promise.all([
      fetch('/status').then(r=>r.json()).catch(()=>({})),
      fetch('/status_temp').then(r=>r.json()).catch(()=>({})),
      fetch('/status_uptime').then(r=>r.json()).catch(()=>({})),
    ]);
    document.getElementById('status_json').textContent = JSON.stringify(status, null, 2);
    document.getElementById('cpu_temp').textContent   = (temp.cpu_temp_c ?? '--');
    const s = (up.uptime_sec ?? 0)|0; const h = Math.floor(s/3600), m = Math.floor((s%3600)/60);
    document.getElementById('uptime').textContent = `${h}h ${m}m`;
  } catch(e){}
}

startVideo();
updateTelemetry();
setInterval(updateTelemetry, 5000);
</script>
</body>
</html>
