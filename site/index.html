<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>RPi-Robot Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #0f1115;
      --panel: #161a22;
      --muted: #9aa4b2;
      --text: #e6edf3;
      --accent: #7aa2f7;
      --ok: #36c692;
      --warn: #f5a524;
      --bad: #f43f5e;
      --card-radius: 16px;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
      background: radial-gradient(1200px 800px at 20% -10%, #151a23, #0b0d11 70%), var(--bg);
      color: var(--text);
    }
    header {
      position: sticky; top: 0; z-index: 3;
      background: rgba(11,13,17,0.6); backdrop-filter: blur(6px);
      border-bottom: 1px solid #1f2430;
    }
    .wrap { max-width: 1200px; margin: 0 auto; padding: 16px; }
    .title { display:flex; align-items:center; gap:12px; }
    .title h1 { font-size: 20px; margin: 0; letter-spacing: .2px; }
    .pill { font-size: 12px; color: var(--muted); border: 1px solid #2a3242; padding: 4px 8px; border-radius: 999px; }
    main { padding-bottom: 48px; }
    .grid {
      display: grid; gap: 16px;
      grid-template-columns: 1.2fr .8fr;
    }
    @media (max-width: 960px) { .grid { grid-template-columns: 1fr; } }
    .panel {
      background: linear-gradient(180deg, #161a22, #131720);
      border: 1px solid #202637;
      border-radius: var(--card-radius);
      box-shadow: 0 10px 30px rgba(0,0,0,.25), inset 0 1px 0 rgba(255,255,255,.03);
      overflow: hidden;
    }
    .panel .hd {
      padding: 12px 14px; border-bottom: 1px solid #202637;
      display: flex; align-items: center; justify-content: space-between;
    }
    .panel .hd h2 { margin:0; font-size: 14px; font-weight: 600; letter-spacing: .3px; }
    .panel .bd { padding: 14px; }
    .video-wrap { display:flex; flex-direction:column; gap:12px; }
    .video {
      width: 100%; aspect-ratio: 16/9; background: #0b0d11; border: 1px solid #22293a; border-radius: 12px; overflow: hidden;
      display: grid; place-items: center;
    }
    .video img, .video video { width: 100%; height: 100%; object-fit: cover; display:block; }
    .row { display:grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
    @media (max-width: 600px) { .row { grid-template-columns: 1fr; } }
    .card {
      background: #121722; border: 1px solid #202637; border-radius: 12px; padding: 12px;
    }
    .card h3 { margin: 0 0 8px 0; font-size: 13px; font-weight: 600; color: var(--accent); }
    .kv { display:flex; justify-content: space-between; gap: 12px; padding: 6px 0; border-top: 1px dashed #232b3c;}
    .kv:first-of-type { border-top: none; }
    .k { color: var(--muted); font-size: 12px; }
    .v { font-variant-numeric: tabular-nums; }
    .muted { color: var(--muted); font-size: 12px; }
    .status-dot { width: 8px; height: 8px; border-radius: 50%; display:inline-block; vertical-align: middle; margin-right:6px; background: var(--warn); }
    .status-dot.ok { background: var(--ok); } .status-dot.bad { background: var(--bad); }
    a.btn {
      display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border:1px solid #2a3242; border-radius:10px; color: var(--text); text-decoration: none;
    }
    code.small { font-size: 12px; color: #aeb8c7; }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="title">
        <span class="pill">RPi-Robot</span>
        <h1>Dashboard</h1>
        <span class="pill" id="overall-status"><span class="status-dot" id="status-dot"></span><span id="status-text">Checking…</span></span>
        <span class="pill" id="uptime-pill">Uptime: <span id="uptime">—</span></span>
      </div>
    </div>
  </header>

  <main class="wrap">
    <div class="grid">
      <!-- Left: Video & quick actions -->
      <section class="panel">
        <div class="hd">
          <h2>Live Video Stream</h2>
          <div class="muted">topic: <code class="small">/image_raw</code></div>
        </div>
        <div class="bd">
          <div class="video-wrap">
            <!-- Option A: MJPEG stream -->
            <div class="video">
              <img id="video" alt="Live video" src="/stream?topic=/image_raw" onerror="this.alt='Video offline'; this.src='';" />
            </div>
            <div style="display:flex; gap:8px; flex-wrap: wrap;">
              <a class="btn" href="/snapshot?topic=/image_raw" target="_blank" rel="noopener">Snapshot</a>
              <a class="btn" href="/status" target="_blank" rel="noopener">Raw /status</a>
              <a class="btn" href="/status_battery" target="_blank" rel="noopener">Raw /status_battery</a>
            </div>
          </div>
        </div>
      </section>

      <!-- Right: Telemetry cards -->
      <aside class="panel">
        <div class="hd">
          <h2>System Telemetry</h2>
          <div class="muted" id="last-refresh">—</div>
        </div>
        <div class="bd">
          <div class="row">
            <!-- CPU -->
            <div class="card">
              <h3>CPU</h3>
              <div class="kv"><div class="k">Temp</div><div class="v" id="cpu-temp">—</div></div>
              <div class="kv"><div class="k">Usage</div><div class="v"><span id="cpu-pct">—</span>%</div></div>
              <div class="kv"><div class="k">Load (1m)</div><div class="v" id="load1">—</div></div>
            </div>

            <!-- Memory / Disk -->
            <div class="card">
              <h3>Resources</h3>
              <div class="kv"><div class="k">RAM Used</div><div class="v" id="mem-used">—</div></div>
              <div class="kv"><div class="k">Disk Used</div><div class="v" id="disk-used">—</div></div>
              <div class="kv"><div class="k">Net (rx / tx)</div><div class="v" id="net-io">—</div></div>
            </div>

            <!-- Battery -->
            <div class="card" id="battery-card">
              <h3>Battery</h3>
              <div class="kv"><div class="k">Voltage</div><div class="v"><span id="batt-v">—</span> V</div></div>
              <div class="kv"><div class="k">Current</div><div class="v"><span id="batt-i">—</span> A</div></div>
              <div class="kv"><div class="k">SoC (est)</div><div class="v"><span id="batt-soc">—</span>%</div></div>
              <div class="kv"><div class="k">Source</div><div class="v muted" id="batt-src">—</div></div>
            </div>
          </div>
        </div>
      </aside>
    </div>

    <!-- Footer / tiny status -->
    <div style="margin-top:16px; color: var(--muted); font-size: 12px;">
      <span>Status JSON:</span>
      <code class="small" id="status-json-hint">/status</code>
    </div>
  </main>

  <script>
    // --- helpers ---
    const $ = (id) => document.getElementById(id);
    const fmt = (n, d=2) => (n === null || n === undefined || Number.isNaN(n)) ? "—" : Number(n).toFixed(d);
    const bytes = (n) => {
      if (n === null || n === undefined) return "—";
      const u = ["B","KB","MB","GB","TB"]; let i=0; let x = Number(n);
      while (x >= 1024 && i < u.length-1) { x /= 1024; i++; }
      return `${x.toFixed(1)} ${u[i]}`;
    };
    const nowStr = () => new Date().toLocaleTimeString();

    async function fetchJSON(path) {
      const r = await fetch(path, { cache: "no-store" });
      if (!r.ok) throw new Error(`${path} HTTP ${r.status}`);
      return r.json();
    }

    // --- renderers ---
    async function renderCore() {
      try {
        const s = await fetchJSON("/status");
        // CPU
        if (s.temp && s.temp.cpu_temp_c != null) $("cpu-temp").textContent = `${fmt(s.temp.cpu_temp_c, 2)} °C`;
        if (s.cpu) {
          if (s.cpu.percent != null) $("cpu-pct").textContent = fmt(s.cpu.percent, 0);
          if (Array.isArray(s.cpu.load_avg)) $("load1").textContent = fmt(s.cpu.load_avg[0], 2);
        }
        // Mem/Disk
        if (s.mem) $("mem-used").textContent = `${bytes(s.mem.used)} / ${bytes(s.mem.total)}`;
        if (s.disk) $("disk-used").textContent = `${bytes(s.disk.used)} / ${bytes(s.disk.total)}`;
        if (s.net) $("net-io").textContent = `${bytes(s.net.bytes_recv)} / ${bytes(s.net.bytes_sent)}`;
        // Uptime
        if (s.uptime && s.uptime.host_uptime_sec != null) {
          const sec = s.uptime.host_uptime_sec;
          const h = Math.floor(sec/3600), m = Math.floor((sec%3600)/60);
          $("uptime").textContent = `${h}h ${m}m`;
        }
        $("last-refresh").textContent = `Updated ${nowStr()}`;
        // Overall status indicator
        $("status-dot").classList.remove("bad"); $("status-dot").classList.add("ok");
        $("status-text").textContent = "Online";
      } catch (e) {
        $("last-refresh").textContent = `Update failed ${nowStr()}`;
        $("status-dot").classList.remove("ok"); $("status-dot").classList.add("bad");
        $("status-text").textContent = "Offline";
      }
    }

    async function renderBattery() {
      try {
        const b = await fetchJSON("/status_battery");
        $("batt-v").textContent = fmt(b.volts, 2);
        $("batt-i").textContent = fmt(b.amps, 2);
        $("batt-soc").textContent = b.soc_est == null ? "—" : Math.round(b.soc_est * 100);
        $("batt-src").textContent = b.source || "unknown";
      } catch {
        $("batt-src").textContent = "error";
      }
    }

    function loop() {
      renderCore();
      renderBattery();
      setTimeout(loop, 3000); // refresh every 3s
    }
    document.addEventListener("DOMContentLoaded", loop);
  </script>
</body>
</html>
