services:
  usb-camera:
    devices:
      - /dev/video0:/dev/video0
    # (optional) you can drop group_add here to avoid the duplicate warning
    command:
      - bash
      - -lc
      - |
        set -euo pipefail
        apt-get update && apt-get install -y --no-install-recommends v4l-utils && rm -rf /var/lib/apt/lists/*
        # Best effort: ask the camera for YUYV @ 640x480/15; if it stays MJPEG, that's fine.
        v4l2-ctl -d /dev/video0 --set-fmt-video=width=640,height=480,pixelformat=YUYV --set-parm=15 || true

        source /opt/ros/iron/setup.bash
        echo "[usb-camera] Launching with pixel_format=mjpeg2rgb"
        exec ros2 run usb_cam usb_cam_node_exe --ros-args \
          -p video_device:=/dev/video0 \
          -p framerate:=15.0 \
          -p image_width:=640 \
          -p image_height:=480 \
          -p io_method:=mmap \
          -p pixel_format:=mjpeg2rgb \
          -r __node:=usb_cam
