name: robot

services:
  ros-core:
    image: ros:iron-ros-core
    restart: unless-stopped
    networks: [robot-net]
    command: ["bash","-lc","source /opt/ros/iron/setup.bash && sleep infinity"]
    environment:
      - ROS_DOMAIN_ID=0

  web-video-server:
    build:
      context: ${PROJECT_ROOT}
      dockerfile: docker/wvs.Dockerfile
    image: robot-web-video-server
    restart: unless-stopped
    networks: [robot-net]
    ports: ["${WVS_PORT:-8080}:8080"]
    depends_on:
      ros-core:
        condition: service_started
    environment:
      - ROS_DOMAIN_ID=0
    healthcheck:
      test: ["CMD-SHELL", "bash -lc 'exec 3<>/dev/tcp/127.0.0.1/8080'"]
      interval: 10s
      timeout: 3s
      retries: 10
      start_period: 10s

  usb-cam:
    image: ros:iron
    container_name: robot-usb-cam-1
    restart: unless-stopped
    devices:
      - /dev/video0:/dev/video0      # or /dev/video1 if that's your camera
    group_add: [video]               # if present in one block
    environment:
      - VIDEO_DEVICE=/dev/video0     # keep consistent with devices
      # any other envs you had
    command: >
      bash -lc "source /opt/ros/iron/setup.bash &&
                ros2 run v4l2_camera v4l2_camera_node"
    networks:
      - robot-net

networks:
  robot-net: {}
